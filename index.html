<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مشروع الملابس</title>
  <!-- Bootstrap 5 RTL -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <style>
    /* تخطيط يجعل الفوتر دائمًا بالأسفل */
    html, body { height: 100%; }
    body{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background: linear-gradient(135deg,#1d697c,#033353,#3a5f66);
      background-size: 200% 200%;
      animation: gradientMove 12s ease infinite;
    }
    @keyframes gradientMove{
      0%{ background-position: 0% 50%; }
      50%{ background-position: 100% 50%; }
      100%{ background-position: 0% 50%; }
    }
    .glass{
      background: #ffffffcc;
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: 0 10px 30px #0000001a;
    }
    .table-responsive{ max-height: 60vh; }
    .brand-title{
      font-weight:800;
      background: linear-gradient(45deg, #111, #333, #000);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    @media print{
      body *{ visibility: hidden; }
      #printTable, #printTable *{ visibility: visible; }
      #printTable{ position: absolute; left:0; top:0; width:100%; }
    }
    footer{
      margin-top:auto;           /* يدفع الفوتر لأسفل */
      background:#022b3a;
      color:#fff;
      text-align:center;
      padding:10px 12px;
      font-size:0.95rem;
      line-height:1.6;
      box-shadow: 0 -4px 16px #00000022;
    }
    footer img{
      height:26px;
      margin: 0 6px;
      vertical-align:middle;
      border-radius:4px;
      background:#fff0;
    }
  </style>
</head>
<body>
  <div class="container py-4 flex-grow-1">
    <header class="text-center text-white mb-4">
      <h1 class="display-5 brand-title">مشروع الملابس</h1>
    </header>

    <section class="glass p-3 p-md-4 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">التاريخ</label>
          <input type="date" id="dateInput" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">اليوم</label>
          <input type="text" id="dayInput" class="form-control" disabled />
        </div>
        <div class="col-md-6">
          <label class="form-label">إرفاق ملف</label>
          <input type="file" id="attachInput" class="form-control" />
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary" id="addBtn">إضافة للسجل</button>
        </div>
      </div>
    </section>

    <section class="glass p-3 p-md-4">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
          <button class="btn btn-success" id="exportBtn">تنزيل نسخة احتياطية</button>
          <label class="btn btn-outline-dark mb-0">استعادة
            <input type="file" id="importInput" accept="application/json" hidden />
          </label>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" id="printBtn">طباعة التقرير</button>
          <div class="input-group">
            <span class="input-group-text">بحث</span>
            <input class="form-control" id="searchInput" placeholder="بحث برقم / تاريخ / يوم / اسم المرفق" />
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table id="printTable" class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>رقم</th>
              <th>التاريخ</th>
              <th>اليوم</th>
              <th>الحالة</th>
              <th>المرفق</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- الفوتر -->
  <footer>
    <img src="https://i.postimg.cc/dV18t4dW/bir-logo.png" alt="شعار الجمعية">
    <span>جميع الحقوق محفوظة لدى جمعية البر الخيرية</span>
  </footer>

  <template id="rowTemplate">
    <tr>
      <td class="serial"></td>
      <td><input type="date" class="form-control form-control-sm date-edit" /></td>
      <td class="day"></td>
      <td class="status"></td>
      <td class="attachment"></td>
      <td>
        <button class="btn btn-sm btn-danger delete">حذف</button>
      </td>
    </tr>
  </template>

  <script>
    const LS_KEY = 'clothesProjectData';
    let records = [];

    const dateInput = document.getElementById('dateInput');
    const dayInput = document.getElementById('dayInput');
    const attachInput = document.getElementById('attachInput');
    const addBtn = document.getElementById('addBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');
    const searchInput = document.getElementById('searchInput');
    const printBtn = document.getElementById('printBtn');

    const tableBody = document.getElementById('tableBody');
    const rowTemplate = document.getElementById('rowTemplate');

    const daysMap = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];

    // اسم اليوم بحساب محلي (يتجنب انزياح المنطقة الزمنية)
    const toDayName = (iso) => {
      if (!iso) return '';
      const [y, m, d] = iso.split('-').map(Number);
      const dt = new Date(y, m - 1, d);
      return daysMap[dt.getDay()] || '';
    };

    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(records)); }
    function load(){ records = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
    function nextId(){ return records.length? Math.max(...records.map(r=>r.id))+1:1; }

    function render(list = records){
      tableBody.innerHTML='';
      const q=(searchInput.value||'').toLowerCase();

      const filtered=list.filter(r=>{
        if(!q) return true;
        return String(r.id).includes(q)
          || (r.date||'').includes(q)
          || (r.day||'').toLowerCase().includes(q)
          || (r.attachmentName||'').toLowerCase().includes(q);
      });

      for(const r of filtered){
        const row=rowTemplate.content.cloneNode(true);
        const tr=row.querySelector('tr');

        tr.querySelector('.serial').textContent=r.id;

        const dateEdit = tr.querySelector('.date-edit');
        dateEdit.value = r.date || '';

        // اليوم
        tr.querySelector('.day').textContent = r.day || '';

        // الحالة
        tr.querySelector('.status').innerHTML = r.hasAttachment
          ? '<span class="badge bg-success">تم</span>'
          : '<span class="badge bg-secondary">لم تتم</span>';

        // المرفق
        tr.querySelector('.attachment').innerHTML = r.hasAttachment
          ? `<a href="${r.attachmentData}" download="${r.attachmentName}">${r.attachmentName}</a>`
          : '<span class="text-muted">لا يوجد</span>';

        // حذف
        tr.querySelector('.delete').onclick = () => {
          records = records.filter(x => x.id !== r.id);
          save(); render();
        };

        // تعديل تاريخ الصف
        dateEdit.addEventListener('change', () => {
          r.date = dateEdit.value;
          r.day  = toDayName(r.date);
          save();
          render();
        });

        tableBody.appendChild(tr);
      }
    }

    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const fr=new FileReader();
        fr.onload=()=>res(fr.result);
        fr.onerror=rej;
        fr.readAsDataURL(file);
      });
    }

    // إضافة سجل
    addBtn.onclick = async () => {
      if(!dateInput.value){ alert('اختر التاريخ'); return; }
      let hasAttachment=false,attachmentName='',attachmentData='';
      if(attachInput.files[0]){
        const f=attachInput.files[0];
        hasAttachment=true; attachmentName=f.name; attachmentData=await fileToDataURL(f);
      }
      records.push({
        id: nextId(),
        date: dateInput.value,
        day: toDayName(dateInput.value),
        hasAttachment,
        attachmentName,
        attachmentData
      });
      save(); render(); attachInput.value='';
    };

    // تنزيل نسخة احتياطية
    exportBtn.onclick=()=>{
      const now=new Date();
      const yyyy=now.getFullYear();
      const mm=String(now.getMonth()+1).padStart(2,'0');
      const dd=String(now.getDate()).padStart(2,'0');
      const dayName=daysMap[now.getDay()]||'';
      const blob=new Blob([JSON.stringify(records)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`backup-clothes-project-${yyyy}-${mm}-${dd}-${dayName}.json`;
      a.click();
    };

    // استعادة نسخة
    importInput.onchange=async e=>{
      const f=e.target.files[0];
      if(!f) return;
      const text=await f.text();
      records=JSON.parse(text);
      save(); render();
    };

    // بحث
    searchInput.oninput=()=>render();

    // طباعة الجدول فقط
    printBtn.onclick=()=>{ window.print(); };

    // نسخ احتياطي يومي تلقائي
    function downloadBackupWithName(dateObj){
      const yyyy=dateObj.getFullYear();
      const mm=String(dateObj.getMonth()+1).padStart(2,'0');
      const dd=String(dateObj.getDate()).padStart(2,'0');
      const dayName=daysMap[dateObj.getDay()]||'';
      const blob=new Blob([JSON.stringify(records)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`backup-clothes-project-${yyyy}-${mm}-${dd}-${dayName}.json`;
      a.click();
    }
    function maybeDailyAutoBackup(){
      try{
        const key=LS_KEY+':lastBackupDate';
        const today=new Date().toISOString().slice(0,10);
        const last=localStorage.getItem(key);
        if(last!==today){
          downloadBackupWithName(new Date());
          localStorage.setItem(key,today);
        }
      }catch(err){ console.warn('Daily backup skipped:', err); }
    }

    // تحديث "اليوم" عند تغيير التاريخ في الفورم
    dateInput.addEventListener('input', () => {
      dayInput.value = toDayName(dateInput.value) || '';
    });

    // تهيئة
    (function init(){
      const now=new Date();
      const isoToday = new Date(now.getFullYear(), now.getMonth(), now.getDate())
                        .toISOString().slice(0,10);
      dateInput.value = isoToday;
      dayInput.value = toDayName(dateInput.value);

      load();
      render();
      maybeDailyAutoBackup();
    })();
  </script>
</body>
</html>
